<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Tournament Registration Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1, h2 {
            color: #2c3e50;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #ccc;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .file-info {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .tab-container {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 8px 8px 0 0;
        }
        .tab-button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
        }
        .tab-button:hover {
            background-color: #ddd;
        }
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
        #registrantsTable {
            overflow-x: auto;
        }
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chess Tournament Registration Dashboard</h1>
        
        <div class="upload-section">
            <h2>Upload Registration CSV</h2>
            <input type="file" id="csvFileInput" accept=".csv" />
            <button class="btn" id="uploadBtn">Process Data</button>
            <div class="file-info" id="fileInfo"></div>
        </div>

        <div class="stats-container" id="statsContainer">
            <!-- Stats cards will be inserted here -->
        </div>
        
        <div class="tab-container">
            <button class="tab-button active" onclick="openTab(event, 'graphsTab')">Graphs</button>
            <button class="tab-button" onclick="openTab(event, 'tableTab')">Registrants</button>
        </div>
        
        <div id="graphsTab" class="tab-content" style="display: block;">
            <div class="dashboard">
                <div class="chart-container">
                    <h2>Sections Breakdown</h2>
                    <canvas id="sectionsChart"></canvas>
                </div>
                <div class="chart-container">
                    <h2>Rated vs Unrated Players</h2>
                    <canvas id="ratedChart"></canvas>
                </div>
                <div class="chart-container">
                    <h2>Registration Timeline</h2>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="tableTab" class="tab-content">
            <div id="registrantsTable">
                <!-- Table will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables to store the data
        let registrationData = [];
        let sections = {};
        let registrationTimeline = {};
        
        // Define chart instances to update later
        let sectionsChart;
        let ratedChart;
        let timelineChart;
        
        // Initialize with default data if available via the window.fs API
        async function init() {
            try {
                const response = await window.fs.readFile('Windsor Open Chess Tournament  March 22 2025 Responses  Form Responses 1.csv', { encoding: 'utf8' });
                processCSVData(response);
            } catch (error) {
                console.log("No default file available, waiting for user upload.");
                document.getElementById('fileInfo').textContent = "No data loaded. Please upload a CSV file.";
            }
        }
        
        // Process uploaded CSV file
        document.getElementById('uploadBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (file) {
                document.getElementById('fileInfo').textContent = "Processing file: " + file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvData = e.target.result;
                    processCSVData(csvData);
                };
                reader.readAsText(file);
            } else {
                alert("Please select a CSV file.");
            }
        });
        
        // Function to process CSV data
        function processCSVData(csvData) {
            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    registrationData = results.data;
                    
                    // Update file info
                    document.getElementById('fileInfo').textContent = "Loaded " + registrationData.length + " registrations successfully.";
                    
                    // Analyze the data
                    analyzeData();
                    
                    // Update the UI
                    updateStats();
                    updateCharts();
                    createRegistrantsTable();
                },
                error: function(error) {
                    console.error("Error parsing CSV:", error);
                    document.getElementById('fileInfo').textContent = "Error processing file. Please check format.";
                }
            });
        }
        
        // Analyze the data to extract metrics
        function analyzeData() {
            // Reset data containers
            sections = {};
            registrationTimeline = {};
            
            // Process sections
            registrationData.forEach(entry => {
                const section = entry["What section?"];
                if (section) {
                    sections[section] = (sections[section] || 0) + 1;
                }
                
                // Process timestamps for timeline
                if (entry["Timestamp"]) {
                    // Handle various date formats
                    let timestamp;
                    const timestampStr = entry["Timestamp"];
                    
                    // Try different date formats
                    if (timestampStr.includes('/')) {
                        // Format like MM/DD/YYYY or M/D/YYYY
                        const parts = timestampStr.split(' ')[0].split('/');
                        if (parts.length === 3) {
                            // Assuming MM/DD/YYYY format
                            const month = parseInt(parts[0]) - 1; // JS months are 0-indexed
                            const day = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            timestamp = new Date(year, month, day);
                        }
                    } else {
                        // Try standard date parsing
                        timestamp = new Date(timestampStr);
                    }
                    
                    if (timestamp && !isNaN(timestamp.getTime())) {
                        const dateStr = timestamp.toISOString().split('T')[0];
                        registrationTimeline[dateStr] = (registrationTimeline[dateStr] || 0) + 1;
                    }
                }
            });
            
            // Sort the timeline by date
            registrationTimeline = Object.fromEntries(
                Object.entries(registrationTimeline).sort(([a], [b]) => new Date(a) - new Date(b))
            );
        }
        
        // Update stats cards
        function updateStats() {
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = ''; // Clear existing stats
            
            // Total registrants
            const totalCard = createStatCard(registrationData.length, "Total Registrants");
            statsContainer.appendChild(totalCard);
            
            // Count players with CFC ID
            const ratedPlayers = registrationData.filter(entry => 
                entry["CFC ID (ONLY if playing in a rated section)"] !== null && 
                !isNaN(entry["CFC ID (ONLY if playing in a rated section)"])
            ).length;
            
            const ratedCard = createStatCard(ratedPlayers, "Rated Players");
            statsContainer.appendChild(ratedCard);
            
            const unratedCard = createStatCard(registrationData.length - ratedPlayers, "Unrated Players");
            statsContainer.appendChild(unratedCard);
            
            // Most popular section
            if (Object.keys(sections).length > 0) {
                const mostPopularSection = Object.keys(sections).reduce((a, b) => 
                    sections[a] > sections[b] ? a : b
                );
                
                const sectionCard = createStatCard(
                    sections[mostPopularSection], 
                    `Most Popular: ${mostPopularSection}`
                );
                statsContainer.appendChild(sectionCard);
            }
        }
        
        // Create a stat card element
        function createStatCard(value, label) {
            const card = document.createElement('div');
            card.className = 'stat-card';
            
            const valueEl = document.createElement('div');
            valueEl.className = 'stat-value';
            valueEl.textContent = value;
            
            const labelEl = document.createElement('div');
            labelEl.className = 'stat-label';
            labelEl.textContent = label;
            
            card.appendChild(valueEl);
            card.appendChild(labelEl);
            
            return card;
        }
        
        // Update all charts
        function updateCharts() {
            updateSectionsChart();
            updateRatedChart();
            updateTimelineChart();
        }
        
        // Update the sections breakdown chart
        function updateSectionsChart() {
            const ctx = document.getElementById('sectionsChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (sectionsChart) {
                sectionsChart.destroy();
            }
            
            const sectionLabels = Object.keys(sections);
            const sectionData = sectionLabels.map(label => sections[label]);
            
            // Generate colors for sections
            const backgroundColors = [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)'
            ];
            
            sectionsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sectionLabels,
                    datasets: [{
                        data: sectionData,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update the rated vs unrated players chart
        function updateRatedChart() {
            const ctx = document.getElementById('ratedChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (ratedChart) {
                ratedChart.destroy();
            }
            
            // Count players with CFC ID
            const ratedPlayers = registrationData.filter(entry => 
                entry["CFC ID (ONLY if playing in a rated section)"] !== null && 
                !isNaN(entry["CFC ID (ONLY if playing in a rated section)"])
            ).length;
            
            const unratedPlayers = registrationData.length - ratedPlayers;
            
            ratedChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Rated Players', 'Unrated Players'],
                    datasets: [{
                        data: [ratedPlayers, unratedPlayers],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update the registration timeline chart
        function updateTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (timelineChart) {
                timelineChart.destroy();
            }
            
            // Generate a complete date range to fill in gaps
            let allDates = [];
            if (Object.keys(registrationTimeline).length > 0) {
                // Find min and max dates
                const minDate = new Date(Math.min(...Object.keys(registrationTimeline).map(d => new Date(d).getTime())));
                const maxDate = new Date(Math.max(...Object.keys(registrationTimeline).map(d => new Date(d).getTime())));
                
                // Create array of all dates in range
                const currentDate = new Date(minDate);
                while (currentDate <= maxDate) {
                    allDates.push(currentDate.toISOString().split('T')[0]);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            } else {
                allDates = [];
            }
            
            // Format dates for display (e.g., Feb 15)
            const formattedDates = allDates.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            // Fill in registration counts, using 0 for days with no registrations
            const registrationCounts = allDates.map(date => registrationTimeline[date] || 0);
            
            // Calculate cumulative registrations
            const cumulativeData = [];
            let cumulative = 0;
            for (const count of registrationCounts) {
                cumulative += count;
                cumulativeData.push(cumulative);
            }
            
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedDates,
                    datasets: [
                        {
                            label: 'Daily Registrations',
                            data: registrationCounts,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            tension: 0.1,
                            yAxisID: 'y',
                            type: 'bar'
                        },
                        {
                            label: 'Cumulative Registrations',
                            data: cumulativeData,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            tension: 0.1,
                            yAxisID: 'y1',
                            type: 'line'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 20
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Daily Count'
                            },
                            suggestedMax: Math.max(...registrationCounts) + 1
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cumulative Count'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return allDates[context[0].dataIndex];
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Create the registrants table
        function createRegistrantsTable() {
            const tableContainer = document.getElementById('registrantsTable');
            
            if (registrationData.length === 0) {
                tableContainer.innerHTML = '<p>No data available.</p>';
                return;
            }
            
            // Create table
            const table = document.createElement('table');
            
            // Create header row
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // Get column headers (assuming first entry has all headers)
            const headers = Object.keys(registrationData[0]);
            
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            registrationData.forEach(entry => {
                const row = document.createElement('tr');
                
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = entry[header] !== null ? entry[header] : '';
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
        }
        
        // Tab functionality
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].style.display = 'none';
            }
            
            const tabButtons = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].className = tabButtons[i].className.replace(' active', '');
            }
            
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.className += ' active';
        }
        
        // Initialize the dashboard
        window.onload = init;
    </script>
</body>
</html>
